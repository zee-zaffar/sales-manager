{% extends 'base.html' %}

{% block title %} Orders {% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Orders List</h2>
        <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">Add New Order</a>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Order No</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Qty</th>
                    <th>Sales Tax</th>
                    <th>Platform</th>
                    <th>Source</th>
                    <th>Color</th>
                    <th>Comments</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ order.order_no }}</td>
                    <td>{{ order.order_date }}</td>
                    <td>{{ order.order_amount }}</td>
                    <td>{{ order.qty }}</td>
                    <td>{{ order.sales_tax }}</td>
                    <td>{{ order.platform }}</td>
                    <td>{{ order.source }}</td>
                    <td>{{ order.color }}</td>
                    <td>{{ order.comments }}</td>
                    <td><a href="#" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editOrderModal" data-order='{{ order | tojson }}'>Edit</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Order Modal -->
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addOrderModalLabel">Add New Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addOrderForm">
          <div class="mb-3">
            <label for="orderNo" class="form-label">Order No</label>
            <input type="text" class="form-control" id="orderNo" name="order_no" required>
          </div>
          <div class="mb-3">
            <label for="orderDate" class="form-label">Order Date</label>
            <input type="date" class="form-control" id="orderDate" name="order_date" required>
          </div>
          <div class="mb-3">
            <label for="orderAmount" class="form-label">Order Amount</label>
            <input type="number" step="0.01" class="form-control" id="orderAmount" name="order_amount" required>
          </div>
          <div class="mb-3">
            <label for="qty" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="qty" name="qty" required>
          </div>
          <div class="mb-3">
            <label for="salesTax" class="form-label">Sales Tax</label>
            <input type="number" step="0.01" class="form-control" id="salesTax" name="sales_tax" required>
          </div>
          <div class="mb-3">
            <label for="platform" class="form-label">Platform</label>
            <input type="text" class="form-control" id="platform" name="platform" required>
          </div>
          <div class="mb-3">
            <label for="source" class="form-label">Source</label>
            <input type="text" class="form-control" id="source" name="source" required>
          </div>
          <div class="mb-3">
            <label for="color" class="form-label">Color</label>
            <input type="text" class="form-control" id="color" name="color">
          </div>
          <div class="mb-3">
            <label for="comments" class="form-label">Comments</label>
            <textarea class="form-control" id="comments" name="comments" rows="2"></textarea>
          </div>
          <button type="submit" class="btn btn-success">Add Order</button>
        </form>
        <div id="addOrderMsg" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Order Modal -->
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editOrderModalLabel">Edit Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editOrderForm">
          <input type="hidden" id="editOrderNo" name="order_no">
          <div class="mb-3">
            <label for="editOrderDate" class="form-label">Order Date</label>
            <input type="date" class="form-control" id="editOrderDate" name="order_date" required>
          </div>
          <div class="mb-3">
            <label for="editOrderAmount" class="form-label">Order Amount</label>
            <input type="number" step="0.01" class="form-control" id="editOrderAmount" name="order_amount" required>
          </div>
          <div class="mb-3">
            <label for="editQty" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="editQty" name="qty" required>
          </div>
          <div class="mb-3">
            <label for="editSalesTax" class="form-label">Sales Tax</label>
            <input type="number" step="0.01" class="form-control" id="editSalesTax" name="sales_tax" required>
          </div>
          <div class="mb-3">
            <label for="editPlatform" class="form-label">Platform</label>
            <input type="text" class="form-control" id="editPlatform" name="platform" required>
          </div>
          <div class="mb-3">
            <label for="editSource" class="form-label">Source</label>
            <input type="text" class="form-control" id="editSource" name="source" required>
          </div>
          <div class="mb-3">
            <label for="editColor" class="form-label">Color</label>
            <input type="text" class="form-control" id="editColor" name="color">
          </div>
          <div class="mb-3">
            <label for="editComments" class="form-label">Comments</label>
            <textarea class="form-control" id="editComments" name="comments" rows="2"></textarea>
          </div>
          <button type="submit" class="btn btn-success">Update Order</button>
        </form>
        <div id="editOrderMsg" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Handle Edit button click to populate modal
const editOrderModal = document.getElementById('editOrderModal');
editOrderModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const order = JSON.parse(button.getAttribute('data-order'));
    document.getElementById('editOrderNo').value = order.order_no;
    document.getElementById('editOrderDate').value = order.order_date.split('T')[0];
    document.getElementById('editOrderAmount').value = order.order_amount;
    document.getElementById('editQty').value = order.qty;
    document.getElementById('editSalesTax').value = order.sales_tax;
    document.getElementById('editPlatform').value = order.platform;
    document.getElementById('editSource').value = order.source;
    document.getElementById('editColor').value = order.color;
    document.getElementById('editComments').value = order.comments;
});

// AJAX for Add Order
const addOrderForm = document.getElementById('addOrderForm');
addOrderForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(addOrderForm);
    fetch('/add_order', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const msgDiv = document.getElementById('addOrderMsg');
        if (data.success) {
            msgDiv.innerHTML = '<div class="alert alert-success">Order added successfully!</div>';
            setTimeout(() => { location.reload(); }, 1000);
        } else {
            msgDiv.innerHTML = '<div class="alert alert-danger">' + (data.error || 'Failed to add order.') + '</div>';
        }
    })
    .catch(() => {
        document.getElementById('addOrderMsg').innerHTML = '<div class="alert alert-danger">Error occurred.</div>';
    });
});

// AJAX for Edit Order
const editOrderForm = document.getElementById('editOrderForm');
editOrderForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(editOrderForm);
    fetch('/update_order', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const msgDiv = document.getElementById('editOrderMsg');
        if (data.success) {
            msgDiv.innerHTML = '<div class="alert alert-success">Order updated successfully!</div>';
            setTimeout(() => { location.reload(); }, 1000);
        } else {
            msgDiv.innerHTML = '<div class="alert alert-danger">' + (data.error || 'Failed to update order.') + '</div>';
        }
    })
    .catch(() => {
        document.getElementById('editOrderMsg').innerHTML = '<div class="alert alert-danger">Error occurred.</div>';
    });
});
</script>
{% endblock %}
