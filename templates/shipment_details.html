{% extends 'base.html' %}

{% block title %} Products {% endblock %}

{% block content %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Shipment Details</h1>
    </div>
    <div class="card mb-4">
        <!-- Add Shipment Detail Modal -->
        <div class="modal fade" id="addShipmentDetailModal" tabindex="-1" aria-labelledby="addDetailModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <form class="modal-content" method="post" action="/shipments/{{ shipment.id }}/details/add">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addDetailModalLabel">Add Shipment Detail for Shipment #{{
                            shipment.id }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="shipment_header_id" value="{{ shipment.id }}">
                        <div class="mb-3">
                            <label for="detailDescription" class="form-label">Description</label>
                            <input id="detailDescription" name="description" type="text" class="form-control"
                                maxlength="255" required>
                        </div>
                        <div class="mb-3">
                            <label for="detailSKU" class="form-label">SKU</label>
                            <input id="detailSKU" name="sku" type="text" class="form-control" maxlength="100" required>
                        </div>
                        <div class="mb-3">
                            <label for="detailQuantity" class="form-label">Quantity</label>
                            <input id="detailQuantity" name="quantity" type="number" min="1" class="form-control"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="detailUnitPrice" class="form-label">Unit Price</label>
                            <input id="detailUnitPrice" name="unit_price" type="number" step="0.01" min="0"
                                class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="detailComments" class="form-label">Comments</label>
                            <textarea id="detailComments" name="comments" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Save Detail</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Edit Shipment Detail Modal -->
        <div class="modal fade" id="editShipmentDetailModal" tabindex="-1" aria-labelledby="editDetailModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <form class="modal-content" method="post" action="/shipments/{{ shipment.id }}/details/update">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editDetailModalLabel">Edit Shipment Detail</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editDetailId" name="detail_id">
                        <input type="hidden" name="shipment_header_id" value="{{ shipment.id }}">
                        <div class="mb-3">
                            <label for="editDetailDescription" class="form-label">Description</label>
                            <input id="editDetailDescription" name="description" type="text" class="form-control"
                                maxlength="255" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDetailSKU" class="form-label">SKU</label>
                            <input id="editDetailSKU" name="sku" type="text" class="form-control" maxlength="100" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDetailQuantity" class="form-label">Quantity</label>
                            <input id="editDetailQuantity" name="quantity" type="number" min="1" class="form-control"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="editDetailUnitPrice" class="form-label">Unit Price</label>
                            <input id="editDetailUnitPrice" name="unit_price" type="number" step="0.01" min="0"
                                class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDetailComments" class="form-label">Comments</label>
                            <textarea id="editDetailComments" name="comments" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Detail</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card-header bg-light">
            <h2 class="h5 mb-0">Shipment Header</h2>
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item"><strong>Supplier Name:</strong> {{ shipment.supplier_name }}</li>
            <li class="list-group-item"><strong>Shipment No:</strong> {{ shipment.shipment_no }}</li>
            <li class="list-group-item"><strong>Date Received:</strong> {{shipment.date_received }}</li>
            <li class="list-group-item"><strong>Comments:</strong> {{ shipment.comments }}</li>
        </ul>
    </div>
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Shipment Details</h2>
                <button type="button" class="btn btn-success" data-bs-toggle="modal"
                    data-bs-target="#addShipmentDetailModal">
                    Add Shipment Detail
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Description</th>
                        <th>SKU</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                        <th>Comments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detail in details %}
                    {% set row_total = detail.quantity * detail.unit_price %}
                    <tr>
                        <td>{{ detail.id }}</td>
                        <td>{{ detail.description }}</td>
                        <td>{{ detail.sku }}</td>
                        <td>{{ detail.quantity }}</td>
                        <td>${{ '%.2f' % detail.unit_price }}</td>
                        <td>${{ '%.2f' % row_total }}</td>
                        <td>{{ detail.comments }}</td>
                      <td>
                <!-- Fix: Change function call and parameters for shipment detail edit -->
                <button type="button" class="btn btn-sm btn-primary" 
                    onclick="openEditDetailModal({{ detail.id }}, '{{ detail.description }}', '{{ detail.sku }}', {{ detail.quantity }}, {{ detail.unit_price }}, '{{ detail.comments }}')">
                    Edit
                </button>
            </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="6" class="text-end">Grand Total:</th>
                        <th colspan="2">${{ '%.2f' % details_grand_total }}</th>
                    </tr>
                 </tfoot>
            </table>
        </div>
    </div>

    <br>
    
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Payments</h2>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                    Add Payment
                </button>
            </div>
        </div>

        <!-- Add Payment Modal -->
        <div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <form class="modal-content" method="post" action="/shipments/{{ shipment.id }}/payments/add">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addPaymentModalLabel">Add Payment for Shipment #{{ shipment.id }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="ShipmentHeaderId" value="{{ shipment.id}}">

                        <div class="mb-3">
                            <label for="paymentDate" class="form-label">Payment Date</label>
                            <input id="paymentDate" name="payment_date" type="date" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="paymentDescription" class="form-label">Description</label>
                            <input id="paymentDescription" name="description" type="text" class="form-control"
                                maxlength="255">
                        </div>

                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">Amount</label>
                            <input id="paymentAmount" name="amount" type="number" step="0.01" min="0"
                                class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="paymentFee" class="form-label">Fee</label>
                            <input id="paymentFee" name="fee" type="number" step="0.01" min="0" class="form-control"
                                value="0.00">
                        </div>

                        <div class="mb-3">
                            <label for="paymentComments" class="form-label">Comments</label>
                            <textarea id="paymentComments" name="comments" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Payment</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Payment Modal -->
        <div class="modal fade" id="editPaymentModal" tabindex="-1" aria-labelledby="editPaymentModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <form class="modal-content" method="post" action="/shipments/{{ shipment.id }}/payments/update">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editPaymentModalLabel">Edit Payment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editPaymentId" name="payment_id">
                        <input type="hidden" name="ShipmentHeaderId" value="{{ shipment.id}}">

                        <div class="mb-3">
                            <label for="editPaymentDate" class="form-label">Payment Date</label>
                            <input id="editPaymentDate" name="payment_date" type="date" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="editPaymentDescription" class="form-label">Description</label>
                            <input id="editPaymentDescription" name="description" type="text" class="form-control"
                                maxlength="255">
                        </div>

                        <div class="mb-3">
                            <label for="editPaymentAmount" class="form-label">Amount</label>
                            <input id="editPaymentAmount" name="amount" type="number" step="0.01" min="0"
                                class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="editPaymentFee" class="form-label">Fee</label>
                            <input id="editPaymentFee" name="fee" type="number" step="0.01" min="0" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label for="editPaymentComments" class="form-label">Comments</label>
                            <textarea id="editPaymentComments" name="comments" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Payment</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Reset the form each time the modal is opened
            document.addEventListener('DOMContentLoaded', function () {
                var addPaymentModal = document.getElementById('addPaymentModal');
                addPaymentModal.addEventListener('show.bs.modal', function () {
                    this.querySelector('form').reset();
                    // set default date to today
                    var dateInput = this.querySelector('#paymentDate');
                    if (dateInput) {
                        var today = new Date().toISOString().slice(0, 10);
                        dateInput.value = today;
                    }
                });
            });

             // Function to open edit detail modal with data
            function openEditDetailModal(id, description, sku, quantity, unitPrice, comments) {
                document.getElementById('editDetailId').value = id;
                document.getElementById('editDetailDescription').value = description;
                document.getElementById('editDetailSKU').value = sku;
                document.getElementById('editDetailQuantity').value = quantity;
                document.getElementById('editDetailUnitPrice').value = unitPrice;
                document.getElementById('editDetailComments').value = comments;
                
                var editModal = new bootstrap.Modal(document.getElementById('editShipmentDetailModal'));
                editModal.show();
            }

            // Function to open edit payment modal with data
            function openEditPaymentModal(id, paymentDate, description, amount, fee, comments) {
                document.getElementById('editPaymentId').value = id;
                document.getElementById('editPaymentDate').value = paymentDate;
                document.getElementById('editPaymentDescription').value = description;
                document.getElementById('editPaymentAmount').value = amount;
                document.getElementById('editPaymentFee').value = fee;
                document.getElementById('editPaymentComments').value = comments;
                
                var editModal = new bootstrap.Modal(document.getElementById('editPaymentModal'));
                editModal.show();
            }
        </script>

        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Shipment Header Id</th>
                        <th>Payment Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Total</th>
                        <th>Comments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                        {% for payment in payments %}
                        {% set payment_total = payment.amount + payment.fee %}
                    <tr>
                        <td>{{ payment.id }}</td>
                        <td>{{ payment.shipment_header_id }}</td>
                        <td>{{ payment.payment_date }}</td>
                        <td>{{ payment.description }}</td>
                        <td>${{ '%.2f' % (payment.amount) }}</td>
                        <td>${{ '%.2f' % (payment.fee) }}</td>
                        <td>${{ '%.2f' % (payment_total) }}</td>
                        <td>{{ payment.comments }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" 
                                onclick="openEditPaymentModal({{ payment.id }}, '{{ payment.payment_date }}', '{{ payment.description }}', {{ payment.amount }}, {{ payment.fee }}, '{{ payment.comments }}')">
                                Edit
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="7" class="text-end">Grand Total:</th>
                        <th colspan="2">${{ '%.2f' % payments_grand_total }}</th>
                    </tr>
                 </tfoot>
            </table>
        </div>
    </div>
    <br>
    <a href="/shipments" class="btn btn-primary">Back to Shipments List</a>
</div>

</div>
<br>

{% endblock %}